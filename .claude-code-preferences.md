# Claude Code Preferences

**READ THIS FIRST before starting any work in this repository.**

## Core Principles

### 1. Deployment Philosophy

**ALWAYS use Kustomize for Kubernetes deployments.**

- ✅ Use Kustomize for all new applications
- ✅ Use Kustomize for all migrations (Docker → Kubernetes)
- ❌ Do NOT use Helm for new deployments
- ⚠️ Helm is acceptable ONLY for:
  - Existing third-party charts with active maintenance
  - Complex applications where Kustomize conversion is prohibitively expensive
  - Must justify why Kustomize won't work

**Examples of good Kustomize deployments in this repo:**
- `apps/production/jimswiki/` - Complex app with 38K+ files
- `apps/production/teslamate/` - Multi-component application
- `apps/production/landingpage/` - React application
- `apps/production/database/` - Shared PostgreSQL
- `apps/production/messaging/` - Shared Mosquitto MQTT

### 2. Secret Management

**NEVER commit secrets in plaintext to git.**

**Approved methods (in order of preference):**

1. **SOPS + Age encryption** (PREFERRED)
   ```bash
   # Store secrets in .env files
   # Encrypt with: ./scripts/encrypt-env-files.sh <directory>
   # Commit only .env*.encrypted files
   ```

2. **Cluster-only Kubernetes Secrets**
   ```bash
   # Create secret directly in cluster (NOT in git)
   kubectl create secret generic my-secret -n namespace \
     --from-literal=key="value"
   # Document in README how to recreate it
   ```

3. **Helm valuesFrom** (only if using Helm)
   ```yaml
   valuesFrom:
     - kind: Secret
       name: my-secret
   ```

**What to NEVER do:**
- ❌ Plaintext passwords in YAML files
- ❌ API keys hardcoded in manifests
- ❌ Secrets in environment variables in deployment files
- ❌ .env files without encryption

**Reference:** See `SECURITY-INCIDENT.md` for real incident and lessons learned.

### 3. Documentation Requirements

**Every application MUST have a README.md** with:

1. Overview - What does this application do?
2. URL - Where is it accessed?
3. Data Paths - Where is persistent data stored?
4. Dependencies - What other services does it need?
5. Configuration - How is it configured?
6. Secrets - How are secrets managed? (with exact kubectl commands)
7. Deployment - How to deploy/update it?
8. Troubleshooting - Common issues and solutions

**Good examples:**
- `apps/production/jimswiki/README.md`
- `apps/production/authentik/SECRET-MANAGEMENT.md`

### 4. Data Path Preservation

**When migrating from Docker to Kubernetes:**

- ✅ Preserve exact data paths (use hostPath if needed)
- ✅ Document all volume mounts clearly
- ✅ Verify data is accessible before removing Docker
- ✅ Test thoroughly with actual data

**Example:** jimswiki migration preserved 38,004 pages at exact same NFS mount path.

### 5. Git Practices

**Commits:**
- Use descriptive commit messages
- Include "why" not just "what"
- Reference related issues/docs
- End with Claude Code attribution

**Branches:**
- Work directly on `master` (small repo, sole maintainer)
- Can use branches for major changes if preferred

**Never commit:**
- Secrets (use SOPS)
- Personal credentials
- Age keys (*.agekey)
- Unencrypted .env files

### 6. Resource Ownership

**Prefer running as apps:apps (3003:3003) when possible:**
```yaml
securityContext:
  runAsUser: 3003
  runAsGroup: 3003
  fsGroup: 3003
```

**Exception:** When image requires root (document why in README)

### 7. Namespace Strategy

- One namespace per logical application
- Shared services get their own namespaces:
  - `database` - Shared PostgreSQL
  - `messaging` - Shared MQTT
  - `monitoring` - Shared Grafana/Prometheus
  - `authentik` - SSO/IdP

### 8. Testing Before Commit

**Always validate before committing:**
```bash
# 1. Validate Kustomize
kubectl kustomize apps/production/myapp/

# 2. Dry-run
kubectl apply -k apps/production/myapp/ --dry-run=client

# 3. Apply to cluster
kubectl apply -k apps/production/myapp/

# 4. Verify deployment
kubectl get pods -n namespace
kubectl logs -n namespace -l app=myapp

# 5. Test functionality (curl, browser, etc.)
```

### 9. Migration Philosophy

**Docker → Kubernetes migrations:**
- Phase by phase (don't rush)
- Test each service thoroughly
- Keep Docker running until k8s proven stable
- Document each phase in docker-migration.md

**Current status:** Phase 3 Complete (all services migrated)

### 10. When in Doubt

1. Check `DEPLOYMENT-GUIDELINES.md`
2. Look for similar examples in `apps/production/`
3. Ask the user for clarification
4. Document your decisions in README

## Quick Reference

| Task | Preferred Tool | Alternative |
|------|---------------|-------------|
| Kubernetes Deployment | Kustomize | Helm (rarely) |
| Secret Storage | SOPS+Age | Cluster-only secret |
| Documentation | README.md | Comments in YAML |
| Testing | kubectl apply --dry-run | Direct apply |
| Git History | Clean commits | Squash if messy |

## Common Commands

```bash
# Apply Kustomization
kubectl apply -k apps/production/myapp/

# Encrypt secrets
./scripts/encrypt-env-files.sh apps/production/myapp/

# Force Flux reconciliation
flux reconcile kustomization flux-system --with-source

# Check Flux status
flux get all -A --status-selector ready=false

# Import Docker image to k3s
docker save myimage:tag | sudo k3s ctr images import -
```

## Remember

- **Security first** - Never compromise on secrets
- **Documentation** - Future you will thank you
- **Kustomize over Helm** - Keep it simple
- **Test thoroughly** - Especially with real data
- **Ask when unsure** - Don't assume

---

**Last Updated:** 2024-11-18

**This file should be read at the start of every Claude Code session working in this repository.**
