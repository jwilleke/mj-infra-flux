apiVersion: v1
kind: ConfigMap
metadata:
  name: jimswiki-startup
  namespace: jimswiki
data:
  startup.sh: |
    #!/bin/bash
    # Move webapp from ROOT to jimswiki context if not already done
    if [ -d "/usr/local/tomcat/webapps/ROOT" ] && [ ! -d "/usr/local/tomcat/webapps/jimswiki" ]; then
        echo "Moving webapp from ROOT to jimswiki context..."
        mv /usr/local/tomcat/webapps/ROOT /usr/local/tomcat/webapps/jimswiki
    fi

    # Copy custom properties file to WEB-INF/classes where JSPWiki expects it
    if [ -f "/var/jspwiki/etc/jspwiki-custom.properties" ]; then
        echo "Copying jspwiki-custom.properties to WEB-INF/classes..."
        cp /var/jspwiki/etc/jspwiki-custom.properties /usr/local/tomcat/webapps/jimswiki/WEB-INF/classes/jspwiki-custom.properties
        echo "Copying log4j2.xml to WEB-INF/classes..."
        cp /var/jspwiki/etc/log4j2.xml /usr/local/tomcat/webapps/jimswiki/WEB-INF/classes/log4j2.xml
    fi

    # Start Tomcat
    exec /usr/local/tomcat/bin/catalina.sh run
